(defpackage :mpi-benchmarks
  (:documentation "benchmark suite for MPI under Lisp")
  (:nicknames #:cl-mpi-benchmarks)
  (:use #:cl #:mpi #:uiop #:cffi :static-vectors)
  (:export run-benchmarks))

(in-package :mpi-benchmarks)

(defun run-benchmarks ()
  (mpi-init)
  (let ((sbuf (make-static-vector
               524288
               :element-type '(signed-byte 32)
               :initial-element 0))
        (rbuf (make-static-vector
               524288
               :element-type '(signed-byte 32)
               :initial-element 0)))
    (pingpong      1  sbuf rbuf 1000000 +mpi-comm-world+)
    (pingpong      2  sbuf rbuf 1000000 +mpi-comm-world+)
    (pingpong      4  sbuf rbuf 1000000 +mpi-comm-world+)
    (pingpong      8  sbuf rbuf  500000 +mpi-comm-world+)
    (pingpong     16  sbuf rbuf  100000 +mpi-comm-world+)
    (pingpong     32  sbuf rbuf  100000 +mpi-comm-world+)
    (pingpong     64  sbuf rbuf  100000 +mpi-comm-world+)
    (pingpong    128  sbuf rbuf   10000 +mpi-comm-world+)
    (pingpong    256  sbuf rbuf   10000 +mpi-comm-world+)
    (pingpong    512  sbuf rbuf   10000 +mpi-comm-world+)
    (pingpong   1024  sbuf rbuf   10000 +mpi-comm-world+)
    (pingpong   2048  sbuf rbuf   10000 +mpi-comm-world+)
    (pingpong   4096  sbuf rbuf   10000 +mpi-comm-world+)
    (pingpong   8192  sbuf rbuf   10000 +mpi-comm-world+)
    (pingpong  16384  sbuf rbuf   10000 +mpi-comm-world+)
    (pingpong  32768  sbuf rbuf   10000 +mpi-comm-world+)
    (pingpong  65536  sbuf rbuf    6400 +mpi-comm-world+)
    (pingpong 131072  sbuf rbuf    3200 +mpi-comm-world+)
    (pingpong 262144  sbuf rbuf    1600 +mpi-comm-world+)
    (pingpong 524288  sbuf rbuf     800 +mpi-comm-world+)
    (free-static-vector sbuf)
    (free-static-vector rbuf)))
