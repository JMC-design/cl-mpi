
(in-package :mpi-benchmarks)

(defun pingpong (msg-size sbuf rbuf iterations comm)
  (declare (type (signed-byte 32) msg-size iterations)
           (type (simple-array (signed-byte 32) (*)) sbuf rbuf))
  (let ((rank (mpi-comm-rank comm)))
    (loop repeat 100 do (mpi-barrier comm))
    (let ((t-begin (mpi-wtime)))
      (locally (declare (optimize speed))
        (loop repeat iterations do
             (if
              (evenp rank)
              (let ((target-rank (+ rank 1)))
                (mpi-send sbuf target-rank :end msg-size)
                (mpi-receive rbuf target-rank :end msg-size))
              (let ((target-rank (- rank 1)))
                (declare (fixnum target-rank))
                (mpi-receive rbuf target-rank :end msg-size)
                (mpi-send sbuf target-rank :end msg-size)))))
      (let* ((seconds (- (mpi-wtime) t-begin))
             (usec (* seconds 1000000.0))
             (usec/iter (/ usec iterations)))
        (if (= 0 rank)
            (format t "pingpong(~A bytes) ~A usec/iteration~%" msg-size usec/iter))))))
